<!-- HEADER -->



<p-toast></p-toast>
<div class="page-header">
  <div class="breadcrumb">Import &gt; <strong>Détails Import</strong></div>
  <div class="header-content">
    <h2 class="title">{{ importData.nomProduit || 'Nom produit non défini' }}</h2>
    <div class="subtitle">
      <i class="pi pi-briefcase mr-2"></i>
      {{ importData.numeroImport }}
    </div>
    <button pButton type="button" icon="pi pi-check" label="Enregistrer" class="bica-btn-orange-save" (click)="saveImportHeader()"></button>
  </div>
</div>
<!-- FORM INFOS IMPORT -->
<p-card class="section-card">
  <h4>Informations Import</h4>
  <div class="grid formgrid p-fluid">
    <div class="field col-12 md:col-4">
      <label>Numéro d'import</label>
      <input pInputText [(ngModel)]="importData.numeroImport" />
    </div>
    <div class="field col-12 md:col-4">
      <label>Produit</label>
      <input pInputText [(ngModel)]="importData.nomProduit" />
    </div>

    <div class="field col-12 md:col-4">
      <label for="dateImport">Date d'import</label>
      <p-calendar
        inputId="dateImport"
        [(ngModel)]="importData.dateImport"
        [showIcon]="true"
      
  
     appendTo="body"
        [showTime]="false"
        dateFormat="yy-mm-dd"   
        class="w-full"
      ></p-calendar>
    </div>
    
    <div class="field col-12 md:col-4">
      <label>Fournisseur</label>
      <input pInputText [(ngModel)]="importData.fournisseur" />
    </div>

    <div class="field col-12 md:col-4">
      <label>Poids Total</label>
      <input pInputText [value]="calculPoidsTotal() + ' Kg'" readonly />
    </div>

    <div class="field col-12 md:col-4">
      <label>Prix total import (€)</label>
      <input
        pInputText
        
        [value]="prixTotalImport + ' EUR'"
        readonly
       
      />
    </div>
    
    <div class="field col-12 md:col-4">
      <label>Facture d'import (PDF)</label>
      <p-fileUpload
      #uploader
      mode="basic"
      [customUpload]="true"
      [auto]="true"
      accept=".pdf"
      chooseLabel="Choisir un PDF"
      (uploadHandler)="onFileUpload($event, uploader)"
      class="w-full"
    />

  </div>
    <div class="field col-12">
      <div *ngIf="importData.fichierImport !== null" class="flex align-items-center gap-2 flex-grow-1 overflow-hidden">
        <i class="pi pi-download text-primary" style="font-size: 1.2rem;"></i>
        <a
          [href]="importData.fichierImport"
          target="_blank"
          [download]="importData.fichierImport"
          class="text-primary underline text-ellipsis white-space-nowrap overflow-hidden max-w-full"
          style="flex: 1;"
        >
          {{ importData.fichierImport }}
        </a>
      </div>
      </div>
   
    <div class="field col-12 md:col-4">
      <label>Fichier Packing List (PDF)</label>
      <p-fileUpload
      #uploader
      mode="basic"
      [customUpload]="true"
      [auto]="true"
      accept=".pdf"
      chooseLabel="Choisir un PDF"
      (uploadHandler)="onFileUploadPackingList($event, uploader)"
      class="w-full"
    />
  
   
    </div>

    <div class="field col-12">
      <div *ngIf="importData.packingList !== null" class="flex align-items-center gap-2 flex-grow-1 overflow-hidden">
        <i class="pi pi-download text-primary" style="font-size: 1.2rem;"></i>
        <a
          [href]="importData.packingList"
          target="_blank"
          [download]="importData.fichierImport"
          class="text-primary underline text-ellipsis white-space-nowrap overflow-hidden max-w-full"
          style="flex: 1;"
        >
          {{ importData.packingList }}
        </a>
      </div>
      </div>
   
    <div class="field col-12">
      <label>Observations</label>
      <textarea pInputTextarea [(ngModel)]="importData.observations"></textarea>
    </div>
  </div>
</p-card>

<!-- FORM AJOUT ROULEAU -->
<p-card class="section-card">
  <h4>Ajouter Rouleau</h4>

  <div class="grid formgrid p-fluid">
    <!-- Laize (mm) -->
    <div class="field col-6 md:col-2">
      <label for="laize">Laize (mm)</label>
      <p-inputNumber
        inputId="laize"
        [(ngModel)]="newRouleau.laize"
        [min]="0"
        [useGrouping]="false"
        [minFractionDigits]="0"
        [maxFractionDigits]="2"
        suffix=" mm">
      </p-inputNumber>
    </div>

    <!-- N° Rouleau -->
    <div class="field col-6 md:col-2">
      <label for="numero">N° Rouleau</label>
      <input id="numero" pInputText [(ngModel)]="newRouleau.numero" />
    </div>

    <!-- Code -->
    <div class="field col-6 md:col-2">
      <label for="code">Code</label>
      <input id="code" pInputText [(ngModel)]="newRouleau.code" />
    </div>
    <div class="field col-6 md:col-2">
      <label for="grammage">Grammage (GR)</label>
      <p-inputNumber
        inputId="grammage"
        [(ngModel)]="newRouleau.grammage"
        [min]="0"
        [useGrouping]="false"
        [minFractionDigits]="0"
        [maxFractionDigits]="2"
        suffix=" gr">
      </p-inputNumber>
    </div>
    <!-- Description (textarea 1 ligne, 40 colonnes) -->
    <div class="field col-12 md:col-4">
      <label for="description">Description</label>
      <textarea
        id="description"
        pInputTextarea
        [(ngModel)]="newRouleau.description"
        [autoResize]="false"
        rows="1"
        cols="40"
        style="width: 100%;">
      </textarea>
    </div>

    <!-- Poids (kg, virgule fr) -->
    <div class="field col-6 md:col-2">
      <label for="poids">Poids (kg)</label>
      <p-inputNumber
        inputId="poids"
        [(ngModel)]="newRouleau.poids"
        mode="decimal"
        locale="fr-FR"
        [min]="0"
        [minFractionDigits]="2"
        [maxFractionDigits]="3"
        suffix=" kg">
      </p-inputNumber>
    </div>

    <!-- Prix (TND, virgule fr) -->
    <div class="field col-6 md:col-2">
      <label for="prix">Prix (EUR)</label>
      <p-inputNumber
        inputId="prix"
        [(ngModel)]="newRouleau.prix"
        mode="decimal"
        locale="fr-FR"
        [min]="0"
        [minFractionDigits]="2"
        [maxFractionDigits]="3"
        suffix=" EUR">
      </p-inputNumber>
    </div>

    <!-- Bouton -->
    <div class="field col-6 md:col-2 flex align-items-end">
      <button
        pButton
        icon="pi pi-plus"
        [label]="rouleauEnCours ? 'Modifier' : 'Ajouter'"
        class="bica-btn-orange"
        (click)="addRouleau()">
      </button>
    </div>
  </div>
</p-card>

<!-- TABLEAU DES ROULEAUX -->
<p-card class="section-card">
  <div class="flex justify-content-between align-items-center mb-2">
    <h4>Rouleaux</h4>

    <div class="flex flex-wrap gap-2 justify-content-end">
      <span class="p-input-icon-left">
        <i class="pi pi-search"></i>
        <input pInputText type="text" placeholder="Search..." class="p-inputtext-sm" />
      </span>
    </div>
  </div>

  <!-- <div class="table-header flex justify-content-between align-items-center mb-2">
    <span></span>
    <span class="p-input-icon-left">
      <i class="pi pi-search"></i>
      <input pInputText type="text" placeholder="Search..." class="p-inputtext-sm" />
    </span>
  </div> -->

  <p-table [value]="importData.rouleaux" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[5, 10, 20]" responsiveLayout="scroll">
    <ng-template pTemplate="header">
      <tr>
        <th>N° Rouleau</th>
        <th>Code</th>
        <th>Laize</th>
        <th>Grammage</th>
        <th>Poids (Kg)</th>
        <th>Prix (€) </th>
        <!-- <th *ngIf="isColVisible('status')">Status</th> -->
        <th *ngIf="isColVisible('dispo')">Disponibilité</th>
        <th>Actions</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-r>
      <tr>
        <td>{{ r.numero }}</td>
        <td>{{ r.code }}</td>
        <td>{{ r.laize }}</td>
        <td>{{ r.grammage }}</td>
        <td>{{ r.poids }}</td>
        <td>{{ r.prix }}</td>
        <!-- <td *ngIf="isColVisible('status')">
          <p-tag 
            [value]="r.valide ? 'Validé' : 'Non validé'" 
            [styleClass]="r.valide ? 'custom-valide' : 'custom-non-valide'">
          </p-tag>

        </td> -->
        <td *ngIf="isColVisible('dispo')">
          <p-tag 
            [value]="r.disponible ? 'Disponible' : 'Indisponible'" 
            [styleClass]="r.disponible ? 'custom-dispo' : 'custom-non-dispo'">
          </p-tag>

        </td>
        <td class="flex gap-2">
          <button pButton icon="pi pi-pencil" class="p-button-text p-button-sm text-green-600" (click)="openEditDialog(r)"></button>
          <button pButton icon="pi pi-trash" class="p-button-text p-button-sm text-red-500" (click)="confirmDelete(r)"></button>
        </td>
      </tr>
    </ng-template>
  </p-table>
</p-card>

  <!-- DIALOG AJOUT / MODIF -->
  <p-dialog [(visible)]="rouleauDialog" header="Rouleau" [modal]="true" [style]="{ width: '400px' }" class="p-fluid" [dismissableMask]="true">
    <ng-template pTemplate="content">
      <div class="field">
        <label>N° Rouleau</label>
        <input pInputText [(ngModel)]="rouleauData.numero" />
      </div>
      <div class="field">
        <label for="code">Code</label>
        <input id="code" pInputText [(ngModel)]="rouleauData.code" />
      </div>
      <div class="field">
        <label for="grammage">Grammage (GR)</label>
        <p-inputNumber
          inputId="grammage"
          [(ngModel)]="rouleauData.grammage"
          [min]="0"
          [useGrouping]="false"
          [minFractionDigits]="0"
          [maxFractionDigits]="2"
          suffix=" gr">
        </p-inputNumber>
      </div>
      <div class="field ">
        <label for="description">Description</label>
        <textarea
          id="description"
          pInputTextarea
          [(ngModel)]="rouleauData.description"
          [autoResize]="false"
          rows="1"
          cols="40"
          style="width: 100%;">
        </textarea>
      </div>
      <div class="field">
        <label>Laize</label>
        <input pInputText [(ngModel)]="rouleauData.laize" />
      </div>
      <div class="field">
        <label for="poids">Poids (kg)</label>
        <p-inputNumber
          inputId="poids"
          [(ngModel)]="rouleauData.poids"
          mode="decimal"
          locale="fr-FR"
          [min]="0"
          [minFractionDigits]="2"
          [maxFractionDigits]="3"
          suffix=" kg">
        </p-inputNumber>
      </div>
      <div class="field">
        <label for="prix">Prix (EUR)</label>
        <p-inputNumber
          inputId="prix"
          [(ngModel)]="rouleauData.prix"
          mode="decimal"
          locale="fr-FR"
          [min]="0"
          [minFractionDigits]="2"
          [maxFractionDigits]="3"
          suffix=" EUR">
        </p-inputNumber>
      </div>
     

      <!-- ✅ Disponibilité -->
      <!-- <div class="field">
        <label>Disponibilité</label>
        <p-dropdown 
          [options]="[{label: 'Disponible', value: true}, {label: 'Indisponible', value: false}]"
          [(ngModel)]="rouleauData.disponible"
          placeholder="Sélectionner disponibilité"
          appendTo="body">
        </p-dropdown>
      </div> -->
    </ng-template>

    <ng-template pTemplate="footer">
      <button pButton label="Annuler" icon="pi pi-times" class="p-button-text" (click)="rouleauDialog = false"></button>
      <button pButton label="Enregistrer" icon="pi pi-check" class="p-button-text" (click)="saveRouleau()"></button>
    </ng-template>
  </p-dialog>


<!-- DIALOG CONFIRMATION SUPPRESSION -->
<p-dialog [(visible)]="deleteRouleauDialog" header="Confirmation" [modal]="true" [style]="{ width: '350px' }">
  <div class="confirmation-content">
    <i class="pi pi-exclamation-triangle mr-2" style="font-size: 2rem;"></i>
    <span>Supprimer le rouleau <strong>{{ rouleauToDelete?.numero }}</strong> ?</span>
  </div>
  <ng-template pTemplate="footer">
    <button pButton label="Non" icon="pi pi-times" class="p-button-text" (click)="deleteRouleauDialog = false"></button>
    <button pButton label="Oui" icon="pi pi-check" class="p-button-text" (click)="deleteConfirmed()"></button>
  </ng-template>
</p-dialog>
