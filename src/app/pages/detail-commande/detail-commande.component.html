<p-toast></p-toast>

<div class="page-wrapper" *ngIf="!loading && !notFound && commande as c">
  <div class="big-card bp-card">

    <!-- HEADER -->
    <header class="hero">
      <div class="header-left">
        <div class="header-top">
          <h2>Commande <span class="accent">{{ c.numeroCommande }}</span></h2>
          <button pButton icon="pi pi-copy" class="p-button-text p-button-sm copy-btn header-copy"
                  (click)="copyNumero()" pTooltip="Copier"></button>
        </div>

        <div class="meta-row">
          <p-tag [value]="c.description || 'â€”'" severity="info"></p-tag>
          <span class="sep"></span>
          <span class="muted">QuantitÃ©</span>
          <span class="strong">{{ formatQtyNoGroup(c.quantite) }}</span>

        </div>
      </div>

      <div class="hero-actions">
            <button pButton icon="pi pi-save" label="Enregistrer" class="p-button-text bica-save"
            (click)="saveAll()"></button>
        <!--<button pButton icon="pi pi-print"   label="Imprimer" class="p-button-text bica-link"></button>-->
        <button pButton icon="pi pi-arrow-left" label="Retour" class="p-button-text bica-link"
                (click)="backToList()"></button>
      </div>
    </header>

    <!-- STATS -->
    <section class="stats">
      <div class="stat chip">
        <div class="stat-title">PrÃ©visualisation</div>
        <div class="stat-value">{{ formatDimension(c) }}</div>
      </div>
      <div class="stat chip">
        <div class="stat-title">Longueur  ( L )</div>
        <div class="stat-value">{{ c.longueur || 0 }} cm</div>
      </div>
      <div class="stat chip">
        <div class="stat-title">Largeur  ( w )</div>
        <div class="stat-value">{{ c.largeur || 0 }} cm</div>
      </div>
      <div class="stat chip">
        <div class="stat-title">Grammage</div>
        <div class="stat-value">{{ c.grammage || 0 }} g/mÂ²</div>
      </div>
    </section>

    <!-- GRID 3 COLONNES -->
    <div class="grid-3">
      <!-- COL 1 : AperÃ§u + upload -->
      <section class="card section">
        <h4 class="card-title">AperÃ§u</h4>

        <div class="image-box">
          <ng-container *ngIf="c.imageSac; else noimg">
            <p-image [src]="c.imageSac + (cacheBust ? ('?t=' + cacheBust) : '')" [preview]="true" alt="image commande"></p-image>
          </ng-container>
          <ng-template #noimg><div class="noimg">Pas dâ€™image</div></ng-template>

          <input #fileInput type="file" accept="image/*" class="hidden" (change)="onPickImage($event, c.id!)" />
          <button pButton type="button" icon="pi pi-upload"
                  class="p-button-rounded p-button-sm p-button-outlined upload-fab"
                  [disabled]="uploading" (click)="fileInput.click()" pTooltip="Changer l'image"></button>

          <p-progressSpinner *ngIf="uploading" [style]="{width:'28px',height:'28px'}" strokeWidth="3" class="upload-spinner">
          </p-progressSpinner>
        </div>
      </section>

      <!-- COL 2 : DÃ©tails & dimensions -->
      <section class="card section details-card">
        <h4 class="card-title">DÃ©tails & dimensions</h4>

        <div class="form two">
          <div class="f">
            <label>NÂ° commande</label>
            <div class="inline">
              <span class="mono">{{ c.numeroCommande }}</span>
              <button pButton icon="pi pi-copy" class="btn-icon copy-btn inline-copy" (click)="copyNumero()"></button>
            </div>
          </div>
          <div class="f">
            <label>Description</label>
            <span class="mono">{{ c.description || 'â€”' }}</span>
          </div>
        </div>

        <p-divider></p-divider>

        <h5 class="muted mb-2">Dimensions du sac</h5>
        <div class="metrics metrics-compact">
          <div class="metric">
            <label for="dimL">Longueur  (L)</label>
            <p-inputNumber
              inputId="dimL"
              [(ngModel)]="c.longueur"
              [min]="0"
              [mode]="'decimal'"
              [minFractionDigits]="0"
              [maxFractionDigits]="6"
              [locale]="'en-US'"
              [useGrouping]="false"
              [suffix]="' cm'"
              [inputStyle]="{ width: '110px' }">
            </p-inputNumber>
          </div>
          <div class="metric">
            <label for="dimW">Largeur  (w)</label>
            <p-inputNumber
              inputId="dimW"
              [(ngModel)]="c.largeur"
              [min]="0"
              [mode]="'decimal'"
              [minFractionDigits]="0"
              [maxFractionDigits]="6"
              [locale]="'en-US'"
              [useGrouping]="false"
              [suffix]="' cm'"
              [inputStyle]="{ width: '110px' }">
            </p-inputNumber>
          </div>
          <div class="metric">
            <label for="dimG">Grammage</label>
            <p-inputNumber
              inputId="dimG"
              [(ngModel)]="c.grammage"
              [min]="0"
              [mode]="'decimal'"
              [minFractionDigits]="0"
              [maxFractionDigits]="6"
              [locale]="'en-US'"
              [useGrouping]="false"
              [suffix]="' g/mÂ²'"
              [inputStyle]="{ width: '120px' }">
            </p-inputNumber>
          </div>
        </div>

        <div class="dim-actions">
          <!--<button pButton icon="pi pi-save" label="Enregistrer" class="p-button-sm bica-save"
                  (click)="saveDimensions()"></button>-->
        </div>

        <small class="muted block mb-3">Format : longueur Ã— largeur (cm) ; grammage (g/mÂ²).</small>


        <p-divider></p-divider>

        <h5 class="muted mb-2">Surface</h5>
        <div class="form two">
          <div class="f">
            <label>Surface (par unitÃ©)</label>
            <input pInputText [readonly]="true"
                  [value]="formatNoGroup(surfaceUnitaire(c), 'cmÂ²')" />
            <small class="muted block mt-1 formula-note">
              S = (L + Â½Â·v + pli) Ã— 2 Ã— (W + v) &nbsp;&nbsp; (v = soufflet)
            </small>
          </div>
        </div>

        <p-divider></p-divider>

        <h5 class="muted mb-2">Poids</h5>
        <!-- ðŸ‘‰ lecture seule mais calcul avec valeurs temporaires -->
        <div class="form two">
          <div class="f">
            <label>Poids total (par unitÃ©)</label>
            <input pInputText [readonly]="true"
                  [value]="formatNoGroup(calculPoidsTotal(c), 'g')" />
          </div>
          <div class="f">
            <label>Poids total commande</label>
            <!--<input pInputText [readonly]="true"
              [value]="formatNoGroup(calculPoidsTotalCommande(c), 'Kg')" />-->
            <!-- Total commande (auto gâ†”Kg), 6 dÃ©cimales tronquÃ©es -->
            <input pInputText [readonly]="true"
                  [value]="formatWeightSmart(calculPoidsTotalCommande(c), 3, 3)" />
          </div>
        </div>

      </section>

      <!-- COL 3 : Options -->
      <section class="card section edit-identite-card">
        <h4 class="card-title">Options & complÃ©ments</h4>

        <div class="field">
          <div class="inline-check">
            <!-- ðŸ‘‰ ne touche pas commande : change uniquement le flag -->
            <p-checkbox [(ngModel)]="hasPoigner" binary="true" inputId="chkPoigner" (onChange)="togglePoigner() " (ngModelChange)="onPoignerChange($event)"></p-checkbox>
            <label for="chkPoigner" class="m-2">PoignÃ©e</label>
          </div>
          <div class="mt-2" *ngIf="hasPoigner">
            <!-- ðŸ‘‰ bind sur la variable temporaire, pas sur c.poidsPoigner -->
            <label for="poidsPoigner">Poids poignÃ©e</label>
                <p-inputNumber
                  inputId="poidsPoigner"
                  [(ngModel)]="poidsPoignerTmp"
                  [min]="0"
                  [mode]="'decimal'"
                  [minFractionDigits]="0"
                  [maxFractionDigits]="6"
                  [step]="0.1"
                  [locale]="'en-US'"
                  [useGrouping]="false"
                  [suffix]="' g'">
                </p-inputNumber>
          </div>
        </div>

        <div class="field">
          <div class="inline-check">
            <p-checkbox [(ngModel)]="hasSoufflet" binary="true" inputId="chkSoufflet" (onChange)="toggleSoufflet()" (ngModelChange)="onSouffletChange($event)"></p-checkbox>
            <label for="chkSoufflet" class="m-2">Soufflet</label>
          </div>
          <div class="mt-2" *ngIf="hasSoufflet">
            <!-- ðŸ‘‰ bind sur la variable temporaire, pas sur c.soufflet -->
            <label for="soufflet">Soufflet  ( v )</label>
            <p-inputNumber
              inputId="soufflet"
              [(ngModel)]="souffletTmp"
              [min]="0"
              [mode]="'decimal'"
              [minFractionDigits]="0"
              [maxFractionDigits]="6"
              [step]="0.1"
              [locale]="'en-US'"
              [useGrouping]="false"
              [suffix]="' cm'">
            </p-inputNumber>
          </div>
        </div>
        <div class="field mt-3 ">
        <label for="pli">Pli (largeur du pli)</label>
<p-inputNumber
  inputId="pli"
  [(ngModel)]="largeurPliTmp"
  [min]="0"
  [max]="5"                        
  [mode]="'decimal'"
  [minFractionDigits]="0"
  [maxFractionDigits]="2"
  [step]="0.1"
  [locale]="'en-US'"
  [useGrouping]="false"
  [suffix]="' cm'"
  (ngModelChange)="validateLargeurPli($event)"   
  class="w-7rem">
</p-inputNumber>

<small class="p-error block mt-1" *ngIf="pliError">{{ pliError }}</small>
<small class="muted block" *ngIf="!pliError">(Max autorisÃ© : 5 cm)</small>

      </div>


        <div class="actions-line">
          <!-- ðŸ‘‰ câ€™est ICI seulement quâ€™on applique has* + *Tmp au modÃ¨le -->
          <!--<button pButton icon="pi pi-save" label="Enregistrer" class="p-button-sm bica-save"
                  (click)="saveCommande()"></button>-->
        </div>
      </section>
    </div>

    <!-- ROULEAUX -->
    <section class="card section">
      <div class="section-head">
        <h4 class="card-title m-0">Rouleaux utilisÃ©s</h4>
        <div class="add-inline">
          <p-dropdown styleClass="rouleau-id" [options]="rouleaux" [(ngModel)]="formAlloc.rouleauId"
                      optionLabel="reference" optionValue="id" [filter]="true" placeholder="Rouleau (R001, 101â€¦)"
                      [showClear]="true"></p-dropdown>
          <p-inputNumber styleClass="poids-kg" [(ngModel)]="formAlloc.poids" [min]="0" [mode]="'decimal'"
                         [maxFractionDigits]="3" [inputStyle]="{ width: '90px' }" inputId="rPoids"
                         placeholder="Poids (kg)"></p-inputNumber>
          <button pButton icon="pi pi-plus" label="RÃ©server" class="p-button-sm bica-add"
                  (click)="reserver(formAlloc.rouleauId, formAlloc.poids)"></button>
        </div>
      </div>

      <p-table
        [value]="displayedAllocations"
        [rows]="8"
        [paginator]="true"
        [rowsPerPageOptions]="[8,16,32]"
        responsiveLayout="stack"
        breakpoint="960px"
        styleClass="minimal rouleaux-table"
      >
        <ng-template pTemplate="header">
          <tr>
            <th class="col-idx">#</th>
            <th>Rouleau</th>
            <th class="col-num">Poids (kg)</th>
            <th class="col-actions"></th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-a>
          <tr>
            <td class="mono col-idx" data-title="#"> {{ a.id }} </td>
            <td class="mono" data-title="Rouleau"> {{ a.rouleauId }} </td>
            <td class="mono col-num" data-title="Poids (kg)"> {{ a.poidsReserve }} </td>
            <td class="text-right col-actions" data-title="Actions">
              <button pButton icon="pi pi-trash" class="p-button-text p-button-danger p-button-rounded p-button-sm"
                      (click)="removeAllocation(a)" pTooltip="Supprimer"></button>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr><td colspan="4" class="muted text-center py-4">Aucun rouleau</td></tr>
        </ng-template>
      </p-table>
    </section>

  </div>
</div>

<!-- STATES -->
<div *ngIf="loading" class="state"><i class="pi pi-spin pi-spinner mr-2"></i> Chargementâ€¦</div>
<div *ngIf="!loading && notFound" class="state">
  <i class="pi pi-exclamation-triangle mr-2"></i> Commande introuvable.
  <button pButton class="p-button-text bica-link ml-2" (click)="backToList()">Retour</button>
</div>
