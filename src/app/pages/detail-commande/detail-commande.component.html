<div class="card px-6 py-6" *ngIf="!loading && !notFound && commande as c">
  <div class="flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="m-0">Commande {{ c.numeroCommande }}</h2>
      <small class="text-600">Dernière mise à jour : {{ c.dateCommande | date:'dd/MM/yyyy' }}</small>
    </div>
    <p-tag [value]="c.statut || '—'" [severity]="getSeverity(c.statut)"></p-tag>
  </div>

  <div class="grid">
    <!-- Image -->
    <div class="col-12 md:col-4">
      <div class="surface-card border-1 surface-border border-round p-3 flex align-items-center justify-content-center" style="min-height:220px">
        <ng-container *ngIf="c.imageUrl; else noimg">
          <p-image [src]="c.imageUrl" [preview]="true" alt="image commande"></p-image>
        </ng-container>
        <ng-template #noimg>
          <span class="text-500">Pas d'image</span>
        </ng-template>
      </div>
    </div>

    <!-- Infos -->
    <div class="col-12 md:col-8">
      <div class="grid formgrid p-fluid">
        <div class="col-12 md:col-6">
          <label class="text-600 lbl">N° commande</label>
          <div class="flex align-items-center gap-2">
            <span class="font-semibold">{{ c.numeroCommande }}</span>
            <button pButton type="button"
                    icon="pi pi-copy"
                    class="p-button-text p-button-plain p-button-sm"
                    (click)="copyNumero()" pTooltip="Copier" tooltipPosition="top"></button>
          </div>
        </div>

        <div class="col-12 md:col-6">
          <label class="text-600 lbl">Nom commande</label>
          <div class="font-semibold">{{ c.nomCommande }}</div>
        </div>

        <div class="col-12 md:col-6">
          <label class="text-600 lbl">Quantité</label>
          <div class="font-semibold">{{ c.quantite }}</div>
        </div>

        <div class="col-12 md:col-6">
          <label class="text-600 lbl">Date</label>
          <div class="font-semibold">{{ c.dateCommande | date:'dd/MM/yyyy' }}</div>
        </div>
       
        <div class="col-12 md:col-6">
          <label class="text-600 lbl">Statut</label>
          <p-dropdown
            [options]="statutOptions"
            optionLabel="label"
            optionValue="value"
            [ngModel]="c.statut"
            (onChange)="changeStatut($event.value)"
            appendTo="body"
            [style]="{width:'240px'}">
          </p-dropdown>
        </div>
      </div>
    </div>
  </div>

  <div class="grid mt-4">
    <!-- QR code -->
    <div class="col-12 md:col-4">
      <div class="surface-card border-1 surface-border border-round p-3 flex flex-column align-items-center">
        <h4 class="m-0 mb-3">QR Code</h4>
        <qrcode [qrdata]="qrValue" [width]="180" [errorCorrectionLevel]="'M'"></qrcode>
        <small class="text-600 mt-2 text-center break-all">{{ qrValue }}</small>
      </div>
    </div>

    <!-- Pièces jointes -->
    <div class="col-12 md:col-4">
      <div class="surface-card border-1 surface-border border-round p-3">
        <h4 class="m-0 mb-3">Pièces jointes</h4>

        <p-fileUpload
          name="pieces"
          mode="advanced"
          chooseLabel="Ajouter des fichiers"
          [customUpload]="true"
          (uploadHandler)="onUploadPieces($event)"
          [auto]="true"
          [showUploadButton]="false"
          [showCancelButton]="false"
          [multiple]="true"
          accept=".pdf,.png,.jpg,.jpeg">
        </p-fileUpload>

        <ul class="mt-3 list-none p-0" *ngIf="pieces.length; else nofiles">
          <li *ngFor="let p of pieces; let i = index" class="flex align-items-center justify-content-between py-2 border-bottom-1 surface-border">
            <div class="flex align-items-center gap-2">
              <i class="pi pi-paperclip"></i>
              <a [href]="p.url" [download]="p.name">{{ p.name }}</a>
              <small class="text-600">({{ p.size | number }} o)</small>
            </div>
            <div class="flex gap-2">
              <button pButton icon="pi pi-download" class="p-button-rounded p-button-text p-button-sm" (click)="downloadPiece(p)"></button>
              <button pButton icon="pi pi-times" class="p-button-rounded p-button-text p-button-danger p-button-sm" (click)="removePiece(i)"></button>
            </div>
          </li>
        </ul>
        <ng-template #nofiles>
          <span class="text-500">Aucune pièce jointe</span>
        </ng-template>
      </div>
    </div>

    <!-- Rouleaux utilisés -->
    <div class="col-12 md:col-4">
      <div class="surface-card border-1 surface-border border-round p-3">
        <h4 class="m-0 mb-3">Rouleaux utilisés</h4>

        <p-chips
          [(ngModel)]="rouleaux"
          separator=","
          [addOnTab]="true"
          allowDuplicate="false"
          placeholder="Ex: R001, R002">
        </p-chips>

        <!-- Enregistrer en VERT (#70e410) -->
        <button pButton type="button"
                label="Enregistrer"
                icon="pi pi-save"
                class="mt-2 p-button-success"
                (click)="saveRouleaux()"></button>

        <div class="mt-3" *ngIf="rouleaux?.length">
          <span class="text-600 mr-2">Liste :</span>
          <p-chip *ngFor="let r of rouleaux" [label]="r" class="mr-2 mb-2"></p-chip>
        </div>
      </div>
    </div>
  </div>

  <div class="flex justify-content-end gap-2 mt-4">
    <button pButton type="button" icon="pi pi-arrow-left" label="Retour à la liste" (click)="backToList()"></button>
  </div>
</div>

<!-- États -->
<div *ngIf="loading" class="p-4 text-center text-600">
  <i class="pi pi-spin pi-spinner mr-2"></i> Chargement...
</div>

<div *ngIf="!loading && notFound" class="p-4 text-center text-600">
  <i class="pi pi-exclamation-triangle mr-2"></i> Commande introuvable.
  <button pButton type="button" class="p-button-text ml-2" (click)="backToList()">Retour</button>
</div>
