<div class="card px-6 py-6" *ngIf="!loading && !notFound && commande as c">
  <div class="flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="m-0">Commande {{ c.numeroCommande }}</h2>
      <small class="text-600">Modèle : {{ c.modeleName || '—' }}</small>
    </div>
    <!-- plus de statut -->
  </div>
  <p-toast></p-toast>
  <div class="grid">
    <!-- Bloc infos -->
    <div class="col-12 md:col-8">
      <div class="surface-card border-1 surface-border border-round p-3">
        <div class="grid formgrid p-fluid">
          <div class="col-12 md:col-6">
            <label class="text-600 lbl">N° commande</label>
            <div class="flex align-items-center gap-2">
              <span class="font-semibold">{{ c.numeroCommande }}</span>
              <button pButton type="button"
                      icon="pi pi-copy"
                      class="p-button-text p-button-plain p-button-sm"
                      (click)="copyNumero()" pTooltip="Copier" tooltipPosition="top"></button>
            </div>
          </div>

          <div class="col-12 md:col-6">
            <label class="text-600 lbl">Modèle</label>
            <div class="font-semibold">{{ c.modeleName || '—' }}</div>
          </div>

          <div class="col-12 md:col-4">
            <label class="text-600 lbl">Quantité</label>
            <div class="font-semibold">{{ c.quantite }}</div>
          </div>

          <div class="col-12 md:col-4">
            <label class="text-600 lbl">Largeur (mm)</label>
            <div class="font-semibold">{{ c.largeur }}</div>
          </div>

          <div class="col-12 md:col-4">
            <label class="text-600 lbl">Longueur (mm)</label>
            <div class="font-semibold">{{ c.longueur }}</div>
          </div>

          <div class="col-12 md:col-4">
            <label class="text-600 lbl">Épaisseur</label>
            <div class="font-semibold">{{ c.epaisseur }}</div>
          </div>

          <!-- Affichages poids si exposés par l’API -->
          <div class="col-12 md:col-4" *ngIf="c.poidsNecessaire != null">
            <label class="text-600 lbl">Poids nécessaire (kg)</label>
            <div class="font-semibold">{{ n(c.poidsNecessaire) }}</div>
          </div>
          <div class="col-12 md:col-4" *ngIf="c.poidsReserve != null">
            <label class="text-600 lbl">Réservé (kg)</label>
            <div class="font-semibold">{{ n(c.poidsReserve) }}</div>
          </div>
          <div class="col-12 md:col-4" *ngIf="c.poidsConsomme != null">
            <label class="text-600 lbl">Consommé (kg)</label>
            <div class="font-semibold">{{ n(c.poidsConsomme) }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bloc actions + QR -->
    <div class="col-12 md:col-4">
      <div class="surface-card border-1 surface-border border-round p-3">
        <h4 class="m-0 mb-3">Actions</h4>

        <div class="flex flex-column gap-2">
          <div class="p-inputgroup">
            <span class="p-inputgroup-addon">g/m²</span>
            <input pInputText type="number" [(ngModel)]="grammage" min="1" />
            <button pButton label="Calculer" icon="pi pi-calculator" (click)="calculerPoids()"></button>
          </div>

          <div class="flex flex-wrap gap-2">
            <button pButton label="Réserver" icon="pi pi-lock" class="p-button-info" (click)="reserver()"></button>
            <button pButton label="Consommer" icon="pi pi-check-circle" class="p-button-success" (click)="consommer()"></button>
            <button pButton label="Annuler réservations" icon="pi pi-times-circle" class="p-button-danger" (click)="annulerReservations()"></button>
          </div>
        </div>

        <div class="mt-4">
          <h5 class="m-0 mb-2">QR Code</h5>
          <!-- Affichage simple de l’URL ; si tu as ngx-qrcode, décommente : -->
          <!-- <qrcode [qrdata]="qrValue" [width]="180" [errorCorrectionLevel]="'M'"></qrcode> -->
          <small class="text-600 mt-2 text-center break-all block">{{ qrValue }}</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Allocations (si endpoint disponible) -->
  <div class="surface-card border-1 surface-border border-round p-3 mt-4">
    <div class="flex justify-content-between align-items-center mb-3">
      <h4 class="m-0">Allocations (Rouleaux réservés)</h4>
    </div>

    <p-table [value]="allocations" responsiveLayout="scroll" [rows]="5" [paginator]="true" [rowsPerPageOptions]="[5,10,20]">
      <ng-template pTemplate="header">
        <tr>
          <th>ID</th>
          <th>Rouleau</th>
          <th>Poids réservé (kg)</th>
          <th>État</th>
          <th>Date allocation</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-a>
        <tr>
          <td>{{ a.id }}</td>
          <td>{{ a.rouleauId }}</td>
          <td>{{ a.poidsReserve }}</td>
          <td>{{ a.etat }}</td>
          <td>{{ a.dateAllocation | date:'dd/MM/yyyy HH:mm' }}</td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr><td colspan="5" class="text-center py-4">Aucune allocation</td></tr>
      </ng-template>
    </p-table>
  </div>

  <div class="flex justify-content-end gap-2 mt-4">
    <button pButton type="button" icon="pi pi-arrow-left" label="Retour à la liste" (click)="backToList()"></button>
  </div>
</div>

<!-- États -->
<div *ngIf="loading" class="p-4 text-center text-600">
  <i class="pi pi-spin pi-spinner mr-2"></i> Chargement...
</div>

<div *ngIf="!loading && notFound" class="p-4 text-center text-600">
  <i class="pi pi-exclamation-triangle mr-2"></i> Commande introuvable.
  <button pButton type="button" class="p-button-text ml-2" (click)="backToList()">Retour</button>
</div>
